{"version":3,"sources":["../src/app.ts"],"sourcesContent":["import \"reflect-metadata\";\nimport compression from \"compression\";\nimport cookieParser from \"cookie-parser\";\nimport cors from \"cors\";\nimport express from \"express\";\nimport helmet from \"helmet\";\nimport hpp from \"hpp\";\nimport morgan from \"morgan\";\nimport userAgent from \"express-useragent\";\nimport requestIp from \"request-ip\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nimport { NODE_ENV, PORT, LOG_FORMAT, ORIGIN, CREDENTIALS } from \"@config/index\";\nimport { DB } from \"@database\";\nimport { Routes } from \"@interfaces/routes.interface\";\nimport { ErrorMiddleware } from \"@middlewares/error.middleware\";\nimport RateLimitter from \"@middlewares/rate-limitter.middleware\";\n\nimport { logger, stream } from \"@utils/logger\";\n\nexport class App {\n  public app: express.Application;\n  public limit = new RateLimitter();\n\n  private readonly env: string;\n  private readonly port: string | number;\n\n  constructor(routes: Routes[]) {\n    this.app = express();\n    this.env = NODE_ENV || \"development\";\n    this.port = PORT || 3000;\n\n    // Wait for DB to be ready before continuing\n    this.initialize().then(() => {\n      this.initializeRateLimitter();\n      this.initializeMiddlewares();\n      this.initializeRoutes(routes);\n      this.initializeErrorHandling();\n    });\n  }\n\n  public listen() {\n    this.app.listen(this.port, () => {\n      logger.info(\"=================================\");\n      logger.info(`======= ENV: ${this.env} =======`);\n      logger.info(`ðŸš€ App listening on the port ${this.port}`);\n    });\n  }\n\n  public getServer() {\n    return this.app;\n  }\n\n  private async initialize() {\n    // Wait for DB to be ready and sync models\n    while (!DB || !DB.sequelize) {\n      await new Promise((resolve) => setTimeout(resolve, 100));\n    }\n    await DB.sequelize.sync({ alter: true, force: false });\n  }\n\n  private initializeMiddlewares() {\n    this.app.use(morgan(LOG_FORMAT, { stream }));\n    this.app.use(cors({ origin: ORIGIN, credentials: CREDENTIALS }));\n    this.app.use(hpp());\n    this.app.use(helmet());\n    this.app.use(compression());\n    this.app.use(express.json({ limit: \"200mb\", type: \"application/json\" }))\n    this.app.use(express.urlencoded({ extended: true }));\n    this.app.use(cookieParser());\n    this.app.use(requestIp.mw());\n    this.app.use(userAgent.express());\n  }\n\n  private initializeRoutes(routes: Routes[]) {\n    routes.forEach(route => {\n      this.app.use(\"/\", route.router);\n    });\n  }\n\n  private initializeErrorHandling() {\n    this.app.use(ErrorMiddleware);\n  }\n\n  private initializeRateLimitter() {\n    this.app.use(this.limit.default());\n  }\n}"],"names":["App","listen","app","port","logger","info","env","getServer","initialize","DB","sequelize","Promise","resolve","setTimeout","sync","alter","force","initializeMiddlewares","use","morgan","LOG_FORMAT","stream","cors","origin","ORIGIN","credentials","CREDENTIALS","hpp","helmet","compression","express","json","limit","type","urlencoded","extended","cookieParser","requestIp","mw","userAgent","initializeRoutes","routes","forEach","route","router","initializeErrorHandling","ErrorMiddleware","initializeRateLimitter","default","constructor","RateLimitter","NODE_ENV","PORT","then"],"mappings":"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"}