{"version":3,"sources":["../../src/services/account.service.ts"],"sourcesContent":["import { Service } from \"typedi\";\nimport { DB } from \"@database\";\n\nimport { User } from \"@interfaces/user.interface\";\nimport { UserSession } from \"@interfaces/user-session.interface\";\n\nimport { UserModel } from \"@models/users.model\";\nimport { UserSessionModel } from \"@models/users_sessions.model\";\nimport { UpdateUserProfileDto } from \"@dtos/account.dto\";\nimport { HttpException } from \"@/exceptions/HttpException\";\n\n@Service()\nexport class AccountService {\n  public async getProfileByUserId(user_id: number): Promise<User> {\n    const user: UserModel = await DB.Users.findOne({ \n      attributes: { exclude: [\"pk\"] },\n      where: { pk: user_id }\n    });\n\n    const file = await DB.Files.findOne({ where: { pk: user.display_picture }});\n\n    const response = {\n      ...user.get(),\n      display_picture: file?.uuid,\n    };\n\n    return response;\n  }\n\n  public async getSessionsHistoriesByUserId(user_id: number, session_id: string): Promise<UserSession[]> {\n    const userSessions: UserSessionModel[] = await DB.UsersSessions.findAll({\n      attributes: { exclude: [\"pk\", \"user_id\"] },\n      where: { user_id }\n    });\n\n    const userSessionsParsed = userSessions.map(session => ({\n      ...session.get(),\n      is_current: session.uuid === session_id\n    }));\n\n    userSessionsParsed.sort((a, b) => (b.is_current ? 1 : 0) - (a.is_current ? 1 : 0));\n    return userSessionsParsed;\n  }\n\n  public async updateUserProfile(user_id: number, data: UpdateUserProfileDto): Promise<User> {\n    const updatedData: any = {};\n  \n    if (data.full_name) updatedData.full_name = data.full_name;\n  \n    if (data.display_picture) {\n      const file = await DB.Files.findOne({ attributes: [\"pk\"], where: { uuid: data.display_picture, user_id } });\n  \n      if (!file) {\n        throw new HttpException(false, 400, \"File is not found\");\n      }\n  \n      updatedData.display_picture = file.pk;\n    }\n  \n    if (Object.keys(updatedData).length === 0) {\n      throw new HttpException(false, 400, \"Some field is required\");\n    }\n  \n    const [_, [user]] = await DB.Users.update(updatedData, {\n      where: { pk: user_id },\n      returning: true,\n    });\n\n    delete user.dataValues.pk;\n    delete user.dataValues.password;\n\n    const file = await DB.Files.findOne({ where: { pk: user.display_picture }});\n    \n    const response = {\n      ...user.get(),\n      display_picture: file?.uuid,\n    }\n\n    return response;\n  }\n}"],"names":["AccountService","getProfileByUserId","user_id","user","DB","Users","findOne","attributes","exclude","where","pk","file","Files","display_picture","response","get","uuid","getSessionsHistoriesByUserId","session_id","userSessions","UsersSessions","findAll","userSessionsParsed","map","session","is_current","sort","a","b","updateUserProfile","data","updatedData","full_name","HttpException","Object","keys","length","_","update","returning","dataValues","password"],"mappings":";;;;+BAYaA;;;eAAAA;;;wBAZW;0BACL;+BAQW;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGvB,IAAA,AAAMA,iBAAN,MAAMA;IACX,MAAaC,mBAAmBC,OAAe,EAAiB;QAC9D,MAAMC,OAAkB,MAAMC,YAAE,CAACC,KAAK,CAACC,OAAO,CAAC;YAC7CC,YAAY;gBAAEC,SAAS;oBAAC;iBAAK;YAAC;YAC9BC,OAAO;gBAAEC,IAAIR;YAAQ;QACvB;QAEA,MAAMS,OAAO,MAAMP,YAAE,CAACQ,KAAK,CAACN,OAAO,CAAC;YAAEG,OAAO;gBAAEC,IAAIP,KAAKU,eAAe;YAAC;QAAC;QAEzE,MAAMC,WAAW,wCACZX,KAAKY,GAAG;YACXF,eAAe,EAAEF,iBAAAA,2BAAAA,KAAMK,IAAI;;QAG7B,OAAOF;IACT;IAEA,MAAaG,6BAA6Bf,OAAe,EAAEgB,UAAkB,EAA0B;QACrG,MAAMC,eAAmC,MAAMf,YAAE,CAACgB,aAAa,CAACC,OAAO,CAAC;YACtEd,YAAY;gBAAEC,SAAS;oBAAC;oBAAM;iBAAU;YAAC;YACzCC,OAAO;gBAAEP;YAAQ;QACnB;QAEA,MAAMoB,qBAAqBH,aAAaI,GAAG,CAACC,CAAAA,UAAY,wCACnDA,QAAQT,GAAG;gBACdU,YAAYD,QAAQR,IAAI,KAAKE;;QAG/BI,mBAAmBI,IAAI,CAAC,CAACC,GAAGC,IAAM,AAACA,CAAAA,EAAEH,UAAU,GAAG,IAAI,CAAA,IAAME,CAAAA,EAAEF,UAAU,GAAG,IAAI,CAAA;QAC/E,OAAOH;IACT;IAEA,MAAaO,kBAAkB3B,OAAe,EAAE4B,IAA0B,EAAiB;QACzF,MAAMC,cAAmB,CAAC;QAE1B,IAAID,KAAKE,SAAS,EAAED,YAAYC,SAAS,GAAGF,KAAKE,SAAS;QAE1D,IAAIF,KAAKjB,eAAe,EAAE;YACxB,MAAMF,OAAO,MAAMP,YAAE,CAACQ,KAAK,CAACN,OAAO,CAAC;gBAAEC,YAAY;oBAAC;iBAAK;gBAAEE,OAAO;oBAAEO,MAAMc,KAAKjB,eAAe;oBAAEX;gBAAQ;YAAE;YAEzG,IAAI,CAACS,MAAM;gBACT,MAAM,IAAIsB,4BAAa,CAAC,OAAO,KAAK;YACtC;YAEAF,YAAYlB,eAAe,GAAGF,KAAKD,EAAE;QACvC;QAEA,IAAIwB,OAAOC,IAAI,CAACJ,aAAaK,MAAM,KAAK,GAAG;YACzC,MAAM,IAAIH,4BAAa,CAAC,OAAO,KAAK;QACtC;QAEA,MAAM,CAACI,GAAG,CAAClC,KAAK,CAAC,GAAG,MAAMC,YAAE,CAACC,KAAK,CAACiC,MAAM,CAACP,aAAa;YACrDtB,OAAO;gBAAEC,IAAIR;YAAQ;YACrBqC,WAAW;QACb;QAEA,OAAOpC,KAAKqC,UAAU,CAAC9B,EAAE;QACzB,OAAOP,KAAKqC,UAAU,CAACC,QAAQ;QAE/B,MAAM9B,OAAO,MAAMP,YAAE,CAACQ,KAAK,CAACN,OAAO,CAAC;YAAEG,OAAO;gBAAEC,IAAIP,KAAKU,eAAe;YAAC;QAAC;QAEzE,MAAMC,WAAW,wCACZX,KAAKY,GAAG;YACXF,eAAe,EAAEF,iBAAAA,2BAAAA,KAAMK,IAAI;;QAG7B,OAAOF;IACT;AACF"}